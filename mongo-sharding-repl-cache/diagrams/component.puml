@startuml C4_Component
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml

LAYOUT_WITH_LEGEND()

title Компонентная диаграмма MongoDB Sharding с репликацией и кешированием

Container_Boundary(api, "API Application") {
    Component(api_router, "API Router", "FastAPI", "Маршрутизация HTTP запросов")
    Component(api_service, "Data Service", "Python", "Сервис для работы с данными")
    Component(api_cache, "Cache Service", "Python", "Сервис для работы с кешем")
}

Container_Boundary(mongos, "MongoDB Router") {
    Component(mongos_router, "Query Router", "MongoDB", "Маршрутизация запросов к шардам")
    Component(mongos_balancer, "Load Balancer", "MongoDB", "Балансировка нагрузки")
}

Container_Boundary(configsvr, "Config Server") {
    Component(config_metadata, "Metadata Store", "MongoDB", "Хранение метаданных")
    Component(config_chunk, "Chunk Manager", "MongoDB", "Управление чанками")
}

Container_Boundary(shard1, "Shard1") {
    Component(shard1_primary, "Primary Node", "MongoDB", "Основной узел")
    Component(shard1_secondary, "Secondary Node", "MongoDB", "Резервный узел")
}

Container_Boundary(shard2, "Shard2") {
    Component(shard2_primary, "Primary Node", "MongoDB", "Основной узел")
    Component(shard2_secondary, "Secondary Node", "MongoDB", "Резервный узел")
}

Container_Boundary(redis, "Redis Cache") {
    Component(redis_cache, "Cache Store", "Redis", "Хранение кеша")
    Component(redis_eviction, "Eviction Manager", "Redis", "Управление очисткой")
}

Rel(api_router, api_service, "Internal API")
Rel(api_service, api_cache, "Cache Operations")
Rel(api_service, mongos_router, "MongoDB Protocol")
Rel(api_cache, redis_cache, "Redis Protocol")
Rel(mongos_router, mongos_balancer, "Internal")
Rel(mongos_balancer, config_metadata, "MongoDB Protocol")
Rel(mongos_balancer, shard1_primary, "MongoDB Protocol")
Rel(mongos_balancer, shard2_primary, "MongoDB Protocol")
Rel(config_metadata, config_chunk, "Internal")
Rel(shard1_primary, shard1_secondary, "Replication")
Rel(shard2_primary, shard2_secondary, "Replication")
Rel(redis_cache, redis_eviction, "Internal")

@enduml 